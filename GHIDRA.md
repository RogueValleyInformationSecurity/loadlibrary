Debug loadlibrary/mpengine with Ghidra
======================================

The original loadlibrary code includes scripts and instructions to aid debugging loading/execution problems using gdb. The process is as follows:

* Use the `createmap.idc` IDA Pro script to generate a memory map of the analyzed `mpendine.dll` PE file. 
  * The script uses the `gen_file()` API of IDA to generate a [Map Debug File](https://docwiki.embarcadero.com/RADStudio/Athens/en/Map_Debug_File) that has an undocumented format (but of course [IBM has a patent](https://patents.google.com/patent/US6854109B2/en) about how to parse it)
  * In my tests the symbol table ("Publics by Name") generated by IDA references segments that are not included in the generated segment tale, but fortunately later parsing is not bothered by this.
* Use the `genmapsym.sh` to transform the Map Debug File to an object file that includes symbol information.
  * The script uses (GNU!) [awk](https://www.gnu.org/software/gawk/) to parse symbol information...
  * ...and generate assembly from it...
  * ...that can be compiled with [as](https://ftp.gnu.org/old-gnu/Manuals/gas/html_chapter/as_toc.html) to an object file
* The `mpclient` wrapper can detect if it runs in a debugger. If so it breaks execution and provides detailed instructions to load the symbols to [gdb](https://www.gnu.org/software/gawk/) from the generated object file.

Now this is pretty awesome/crazy, but a bit cumbersome esp. because I don't use IDA (thanks for all the little pirates who enabled my testing!). My first idea was to replicate `createmap.idc` as Ghidra script, which [I did](https://gist.github.com/v-p-b/c7d934234297158047b678f655c7d99f), but quickly ran into an assertion failure in `gdb` that I didn't feel like solving. But Ghidra can use `gdb` as a debugger directly, so why don't just use that feature? Here's how:

1. Create a project with `mpclient` and `mpengine.dll` in it. 
2. _Somehow_ set your working directory for `gdb`, otherwise `mpclient` won't find the DLL. It seems this is not really supported from Ghidra so I simply added a `set cwd /path/to/loadlibrary` line to my `~/.gdbinit`. 
3. Open `mpendine.dll` in the Debugger, then open the `Debugger > Configure and Launch mpengine.dll using... > gdb` dialog, and configure your launch settings:
  * Image: `/path/to/mpclient` (not `mpengine.dll`!)
  * Arguments: `/path/to/eicar.com`
  * You can leave the rest as is or tweak according to your needs
4. You can launch the debugee, it'll stop on `_start`, then for displaying symbol loading instructions.
5. Open `Window > Debugger > Static Mappings` and click the little green plus icon in the top right corner to add a new mapping:
  * Program: mpengine.dll
  * Static range: `ram`:`75a101000`,`75ad99ff` (addresses correspond `mpengine.dll`s `.text` section)
  * Trace: mpclient
  * Dynamic range: _Same as Static_
  * You can leave the rest alone


